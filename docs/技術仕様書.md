# Spotify Stats - 技術仕様書

## 📋 プロジェクト概要

**Spotify Stats** は、ユーザーの Spotify リスニング履歴を可視化・分析する Web アプリケーションです。

### 主な機能
- Spotify OAuth 認証によるリアルタイムデータ取得
- ローカル JSON ファイル（Streaming History）のアップロード解析
- Top Tracks / Top Artists のランキング表示
- 月別再生時間のグラフ可視化
- Spotify Wrapped 風画像の生成・ダウンロード

---

## 🏗️ システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  index.php  │  │  stats.php  │  │    analyze.php      │  │
│  │  (ログイン)  │  │ (API表示)   │  │ (ローカル解析)       │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
└─────────┼────────────────┼───────────────────┼──────────────┘
          │                │                   │
          ▼                ▼                   ▼
┌─────────────────────────────────────────────────────────────┐
│                        Backend (PHP)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ callback.php│  │functions.php│  │  JsonStreamer.php   │  │
│  │ (OAuth処理) │  │ (API通信)   │  │ (ストリーム解析)     │  │
│  └──────┬──────┘  └──────┬──────┘  └─────────────────────┘  │
└─────────┼────────────────┼──────────────────────────────────┘
          │                │
          ▼                ▼
┌─────────────────────────────────────────────────────────────┐
│                    External Services                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Spotify Web API                         │    │
│  │   • 認証 API (accounts.spotify.com)                  │    │
│  │   • ユーザーデータ API (api.spotify.com/v1)          │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 技術スタック

### バックエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **PHP** | 7.x+ | サーバーサイドロジック |
| **Apache** | XAMPP | Web サーバー |
| **cURL** | - | Spotify API への HTTP リクエスト |

### フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **HTML5** | - | マークアップ |
| **Tailwind CSS** | CDN (latest) | スタイリング |
| **JavaScript** | ES6+ | インタラクション |
| **Chart.js** | CDN (latest) | グラフ描画 |
| **dom-to-image** | CDN | 画像エクスポート |

---

## 📁 ファイル構成

```
Spotify-Stats/
├── index.php          # ログイン画面・ファイルアップロード
├── callback.php       # OAuth コールバック処理
├── stats.php          # Spotify API データ表示
├── analyze.php        # ローカル JSON 解析・可視化
├── logout.php         # セッション破棄
├── config.php         # API 認証情報
├── functions.php      # 共通関数
├── JsonStreamer.php   # 大容量 JSON ストリーミング解析
├── .htaccess          # PHP 設定（アップロード上限等）
└── README.md          # プロジェクト説明
```

---

## 🔐 認証フロー（OAuth 2.0 Authorization Code Flow）

```
1. ユーザーが「Spotify でログイン」をクリック
        │
        ▼
2. Spotify 認証画面へリダイレクト
   (accounts.spotify.com/authorize)
        │
        ▼
3. ユーザーがアクセス許可
        │
        ▼
4. callback.php が認証コードを受信
        │
        ▼
5. 認証コード → アクセストークン交換
   (accounts.spotify.com/api/token)
        │
        ▼
6. トークンをセッションに保存
        │
        ▼
7. stats.php でユーザーデータ表示
```

### 使用スコープ
- `user-top-read` - トップトラック/アーティスト取得
- `user-read-recently-played` - 最近の再生履歴取得

---

## 💡 技術的なポイント

### 1. 大容量 JSON のストリーミング解析

**課題**: Spotify Extended Streaming History は数百 MB に達することがある

**解決策**: `JsonStreamer.php` でジェネレーターを使用したストリーミング解析

```php
// メモリ効率の良いストリーミング処理
foreach (JsonStreamer::streamJsonItems($filePath) as $record) {
    // 1レコードずつ処理（メモリを圧迫しない）
}
```

### 2. Spotify Wrapped 風画像生成

**実装**: `dom-to-image` ライブラリで DOM を PNG に変換

```javascript
// 1080x1920 の高解像度画像を生成
const dataUrl = await domtoimage.toPng(exportContainer, {
    width: 1080,
    height: 1920
});
```

### 3. レスポンシブ UI

**実装**: Tailwind CSS のユーティリティクラスを活用

```html
<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
  <!-- モバイル: 1列、タブレット以上: 2列 -->
</div>
```

---

## 📊 データフロー

### API 経由（リアルタイム）

```
Spotify API → callSpotifyApi() → stats.php → UI 表示
```

### ファイルアップロード経由

```
JSON ファイル → JsonStreamer → analyze.php → 集計処理 → Chart.js / Wrapped カード
```

---

## ⚙️ サーバー設定（.htaccess）

```apache
php_value upload_max_filesize 1G
php_value post_max_size 1G
php_value memory_limit 1G
php_value max_execution_time 600
```

大容量ファイル対応のため、アップロード上限とメモリを拡張

---

## 🎨 UI/UX デザイン

### カラースキーム
| 用途 | カラーコード |
|------|-------------|
| 背景 | `#121212` |
| 表面 | `#1e1e1e` / `#262626` |
| アクセント（緑） | `#1ed760` |
| テキスト | `#ffffff` / `#9ca3af` |

### デザイン方針
- Spotify 公式アプリに準拠したダークテーマ
- カード型 UI による情報整理
- ホバーエフェクトによるインタラクティブ性

---

## 🔒 セキュリティ対策

| 対策 | 実装方法 |
|------|----------|
| XSS 対策 | `htmlspecialchars()` によるエスケープ |
| セッション管理 | PHP ネイティブセッション |
| API シークレット | `config.php` で管理（環境変数推奨） |

---

## 🚀 今後の改善点

1. **環境変数によるシークレット管理**
2. **リフレッシュトークンの自動更新**
3. **データベースによる履歴保存**
4. **PWA 対応**

---

## 📝 まとめ

本プロジェクトでは以下の技術要素を実践的に学習・実装しました：

- **OAuth 2.0 認証フロー**の実装
- **外部 API（Spotify Web API）**との連携
- **大容量ファイル**のストリーミング処理
- **Chart.js** によるデータ可視化
- **Tailwind CSS** を用いたモダン UI 構築
- **DOM to Image** による画像エクスポート機能
